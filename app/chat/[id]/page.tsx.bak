"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import Link from "next/link";

import OnboardingGate from "@/components/OnboardingGate";
import LumiOrb from "@/components/LumiOrb";

import { MOCK_MATCHES, type Match } from "@/lib/matches";
import {
  analyzeMessage,
  blockUser,
  reportUser,
  isBlocked,
  type ReportReason,
} from "@/lib/safety";

type Msg = {
  id: string;
  from: "me" | "them";
  text: string;
  ts: string;
};

const REPORT_REASONS: ReportReason[] = [
  "Harassment or bullying",
  "Hate speech or discrimination",
  "Sexual harassment",
  "Threatening or intimidating behavior",
  "Stalking or obsessive behavior",
  "Pressuring for personal information",
  "Unwanted sexual messages",
  "Explicit images without consent",
  "Inappropriate language",
  "Spam or repeated unwanted messages",
  "Scam / fake profile",
  "Other",
];

export default function ChatPage() {
  const params = useParams<{ id?: string }>();
  const router = useRouter();
  const id = params?.id ?? "";

  const match: Match | undefined = useMemo(
    () => MOCK_MATCHES.find((m) => m.id === id),
    [id]
  );

  const [blocked, setBlocked] = useState(false);

  const [msgs, setMsgs] = useState<Msg[]>(() => [
    {
      id: "m1",
      from: "them",
      text: "Hey üôÇ what‚Äôs your vibe today?",
      ts: "now",
    },
  ]);

  const [draft, setDraft] = useState("");
  const [safetyNote, setSafetyNote] = useState<string | null>(null);

  const [reportOpen, setReportOpen] = useState(false);
  const [reason, setReason] = useState<ReportReason>("Scam / fake profile");
  const [note, setNote] = useState("");

  const endRef = useRef<HTMLDivElement | null>(null);

  useEffect(() => {
    if (!match) return;
    setBlocked(isBlocked(match.id));
  }, [match]);

  useEffect(() => {
    endRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [msgs.length]);

  if (!match) {
    return (
      <main className="min-h-screen bg-[#0b0b14] text-white flex items-center justify-center">
        <p className="text-white/70">Chat not found.</p>
      </main>
    );
  }

  function send() {
    const text = draft.trim();
    if (!text) return;

    const risk = analyzeMessage(text);

    if (risk.score >= 35) {
      const human =
        risk.flags.includes("asks-for-money")
          ? "Heads up: this message mentions money/payment. That‚Äôs a common scam pattern. Move carefully."
          : risk.flags.includes("off-platform-push")
          ? "Heads up: moving off-app fast is a common scam pattern. Keep it on Rivva until trust is earned."
          : "Heads up: this message matches a few scam/unsafe patterns. Move carefully.";

      setSafetyNote(human);
    } else {
      setSafetyNote(null);
    }

    setMsgs((prev) => [
      ...prev,
      { id: crypto.randomUUID(), from: "me", text, ts: "now" },
    ]);
    setDraft("");
  }

  function doBlock() {
    blockUser(match.id);
    setBlocked(true);
    setReportOpen(false);
  }

  function doReport() {
    reportUser(match.id, reason, note);
    setReportOpen(false);
    setNote("");
  }

  return (
    <OnboardingGate>
      <main className="min-h-screen bg-[#0b0b14] text-white px-6 py-6">
        <section className="max-w-3xl mx-auto">
          <header className="flex items-center justify-between mb-4">
            <button
              type="button"
              onClick={() => router.back()}
              className="text-sm text-white/70 hover:text-white"
            >
              ‚Üê Back
            </button>

            <div className="flex items-center gap-3">
              <Link
                href={`/matches/${match.id}`}
                className="text-sm text-white/70 hover:text-white"
              >
                Profile
              </Link>

              <button
                type="button"
                onClick={() => setReportOpen(true)}
                className="text-sm text-white/70 hover:text-white"
              >
                Block/Report
              </button>

              <div className="scale-75">
                <LumiOrb />
              </div>
            </div>
          </header>

          <div className="rounded-3xl bg-white/5 border border-white/10 shadow-xl overflow-hidden">
            <div className="px-5 py-4 border-b border-white/10 flex items-center justify-between">
              <div>
                <p className="text-sm font-semibold">{match.name}</p>
                <p className="text-xs text-white/60">
                  Keep it on Rivva until trust is earned.
                </p>
              </div>

              {blocked && (
                <span className="text-xs px-3 py-1 rounded-full bg-rose-500/15 border border-rose-400/30 text-rose-200">
                  Blocked
                </span>
              )}
            </div>

            <div className="p-5 space-y-3 max-h-[60vh] overflow-auto">
              {safetyNote && (
                <div className="rounded-2xl bg-amber-500/10 border border-amber-400/25 p-3">
                  <p className="text-xs text-amber-200 font-semibold">
                    Safety nudge
                  </p>
                  <p className="text-xs text-white/70 mt-1">{safetyNote}</p>
                </div>
              )}

              {msgs.map((m) => (
                <div
                  key={m.id}
                  className={
                    "flex " + (m.from === "me" ? "justify-end" : "justify-start")
                  }
                >
                  <div
                    className={
                      "max-w-[80%] rounded-2xl px-4 py-3 text-sm border " +
                      (m.from === "me"
                        ? "bg-white text-black border-white"
                        : "bg-white/5 text-white border-white/10")
                    }
                  >
                    {m.text}
                  </div>
                </div>
              ))}
              <div ref={endRef} />
            </div>

            {blocked ? (
              <div className="px-5 py-4 border-t border-white/10">
                <p className="text-sm text-white/70">
                  You blocked {match.name}. Messaging is disabled.
                </p>
                <p className="text-xs text-white/50 mt-1">
                  In a real app, you‚Äôd also be able to manage blocked users in
                  Settings ‚Üí Privacy & Safety.
                </p>
              </div>
            ) : (
              <div className="px-5 py-4 border-t border-white/10 flex gap-3">
                <input
                  value={draft}
                  onChange={(e) => setDraft(e.target.value)}
                  placeholder="Message‚Ä¶"
                  className="flex-1 rounded-xl bg-white/5 px-3 py-2 text-sm outline-none ring-1 ring-white/10 focus:ring-emerald-400"
                  onKeyDown={(e) => {
                    if (e.key === "Enter") send();
                  }}
                />
                <button
                  type="button"
                  onClick={send}
                  className="px-5 py-2.5 rounded-xl bg-white text-black font-semibold hover:bg-white/90 transition"
                >
                  Send
                </button>
              </div>
            )}
          </div>

          {reportOpen && (
            <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center px-6">
              <div className="w-full max-w-lg rounded-3xl bg-[#0b0b14] border border-white/10 p-6 shadow-2xl">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <p className="text-lg font-semibold">Block or report</p>
                    <p className="text-xs text-white/60 mt-1">
                      Reporting is recorded. Blocking stops messages immediately on your device.
                    </p>
                  </div>
                  <button
                    type="button"
                    onClick={() => setReportOpen(false)}
                    className="text-sm text-white/70 hover:text-white"
                  >
                    ‚úï
                  </button>
                </div>

                <div className="mt-5 space-y-4">
                  <div className="space-y-2">
                    <label className="text-sm font-medium text-white/80">
                      Report reason
                    </label>
                    <select
                      value={reason}
                      onChange={(e) => setReason(e.target.value as ReportReason)}
                      className="w-full rounded-xl bg-white/5 px-3 py-2 text-sm outline-none ring-1 ring-white/10 focus:ring-emerald-400"
                    >
                      {REPORT_REASONS.map((r) => (
                        <option key={r} value={r}>
                          {r}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="space-y-2">
                    <label className="text-sm font-medium text-white/80">
                      Optional note
                    </label>
                    <textarea
                      value={note}
                      onChange={(e) => setNote(e.target.value)}
                      placeholder="Brief context (optional)"
                      rows={3}
                      className="w-full rounded-xl bg-white/5 px-3 py-2 text-sm outline-none ring-1 ring-white/10 focus:ring-emerald-400 resize-none"
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-3 pt-2">
                    <button
                      type="button"
                      onClick={doReport}
                      className="px-5 py-3 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15 transition font-semibold"
                    >
                      Submit report
                    </button>

                    <button
                      type="button"
                      onClick={doBlock}
                      className="px-5 py-3 rounded-xl bg-rose-500 text-rose-950 hover:bg-rose-400 transition font-semibold"
                    >
                      Block now
                    </button>
                  </div>

                  <p className="text-xs text-white/50">
                    Note: We‚Äôre not auto-blocking on report by default because it can be abused. We can add ‚Äúauto-action after repeated verified reports‚Äù later server-side.
                  </p>
                </div>
              </div>
            </div>
          )}
        </section>
      </main>
    </OnboardingGate>
  );
}
